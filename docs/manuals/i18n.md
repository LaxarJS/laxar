# Internationalizing a Widget

[Â« return to the manuals](index.md)

In LaxarJS, internationalization _(i18n)_ of widgets is optional.
Read on if you are interested in writing widgets that support multiple languages, and even switching languages without reloading the page.

Preliminary readings:

* [Widgets and Activities](widgets_and_activities.md)


## Locales and Language Tags: I18n in LaxarJS

LaxarJS distinguishes _locales_ and _language tags_ for internationalization:
Each locale has a constant name such as "default" or "customer" as well as an [RFC-5646](http://tools.ietf.org/html/rfc5646#section-2.1) language tag like "en-US", which can change over time.
The locale corresponds to the audience (users, translators, admins, ...) for which a language tag should be used.
If you have only one audience (regular users), using only _"default"_ should be fine.

The language tag of a given locale can be modified by activities or widgets while the application is running.
This is accomplished by publishing specific events from widgets that would like to set the language tag, and handling them correctly in i18n-capable widgets.

Widgets can use the language tags received over the event bus to _localize_ internationalized values.
Internationalized values are JSON-Objects which contain an entry for each supported language tag.
By convention, variables and properties that contain internationalized values are prefixed with `i18n`:

```js
const i18nHtmlText = {
	"en": "Upload <em>file</em>",
	"de-DE": "<em>Datei</em> hochladen"
}
```

Here, the localization for Germany (`de-DE`) will only be used if the language tag starts with `de-DE`.
For other *variants* of `de` (such as `de-CH`), the configured *fallback tag* (by default `en`) will be used.
Tags are case-insensitive and the underscore (`_`) is normalized to `-`.


## Writing an I18n-Capable Widget

To work with internationalized values, widgets should specify a feature `i18n` in their `widget.json` descriptor.
It allows page authors to configure the name of the locale (e.g. "customer") to be used by this widget.
The actual language tag associated with that locale (for example `en-GB`) is then used for localization.

```json
"i18n": {
   "description": "Which locale to use for displaying this widget.",
   "type": "object",
   "properties": {
      "locale": {
         "type": "string",
         "description": "The topic under which to expect the locale for this widget.",
         "default": "default"
      }
   }
}
```

With this configuration, the [widget service `axI18n`](widget_services.md#) can be injected into the widget controller to localize internationalized values:

```js
function updateView() {
	view.htmlText = axI18n.localize( i18nHtmlText );
}
updateView();
```

The `axI18n` service also helps to stay up-to-date when the language tag is changed:

```js
axI18n.whenLocaleChanged( updateView );
```

The callback passed to `whenLocaleChanged` is invoked with the updated language tag.


## Changing the Language

Sometimes, you may want to offer users the functionality of switching the application language.
The `axI18n.update` method can be used for this:

```js
function onLanguageSelected( newTag ) {
	axI18n.update( newTag );
}
```


## Performing Localization in Templates

Instead of manually performing updates using `whenLocaleChanged`, you can also use `axI18n.track` to put the name of the locale and its language tag onto the widget context.

In particular when using AngularJS (where the context is `$scope`), this allows to perform localization from within the template in a declarative fashion:

```js
axI18n.track();
```

From now on, any updates to the i18n-locale received over the event bus will be saved under `$scope.i18n`, along with their tags.
If a single widget uses more than one language at a time, additional locales may be registered for other features, resulting in something like:

```js
$scope.i18n = {      
   locale: 'default',
   tags: {
      'default': 'en-US',
      'customer': 'de-DE',
      'support': 'en-GB'
   }
}
```

In an AngularJS HTML template we can now use the filter `axLocalize` provided by the [laxar-i18n-control](https://github.com/LaxarJS/laxar-i18n-control) to localize an internationalized value, assuming that `$scope.view` was set to the `view` from the example above:

```html
<p ng-bind-html="view.i18nHtmlText | axLocalize:i18n"></p>
```


## Under the Hood: Locale Change Events

To change the language tag of a locale, a widget has to publish the `changeLocaleRequest.{locale}` event.

*Example:* To change the language tag of the locale `myLocale` to `de-DE`, the following event must be published:

```javascript
$scope.eventBus.publish( 'changeLocaleRequest.myLocale', {
	locale: 'myLocale',
	languageTag: 'de-DE'
} );
```

Usually, you would just use `axI18n.update( 'de-DE' )` to achieve the same effect.

If a widget is interested in changes to `myLocale`, it would subscribe to the corresponding `didChangeLocale`-event, which is published by the LaxarJS flow-controller:

```javascript
eventBus.subscribe( 'didChangeLocale.myLocale', event => {
   axLog.info( 'I have received tag [0] for locale [1]', event.languageTag, event.locale );
} );
```

This is what `axI18n` does behind the scenes to support `localize` and `whenLocaleChanged`.
